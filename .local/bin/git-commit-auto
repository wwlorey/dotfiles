#!/usr/bin/env bash
set -e

if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "fatal: not a git repository (or any of the parent directories): .git"
  exit 1
fi

staged=false
push=false

while [ $# -gt 0 ]; do
  case $1 in
    --staged) staged=true ;;
    --push) push=true ;;
    -h | --help)
      echo "Usage: git commit-auto [--staged] [--push]"
      echo ""
      echo "  --staged  Only commit what's already staged (skip git add -A)"
      echo "  --push    Push after committing"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
  shift
done

if ! $staged; then
  git add -A
fi

if git diff --staged --quiet; then
  echo "Nothing to commit."
  exit 0
fi

diff=$(git diff --staged)
status=$(git status --short)

prompt="You are a commit message generator. Given the following git diff and status, write a single concise commit message. Output ONLY the commit message text, nothing else. No quotes, no prefixes, no explanation.

git status:
$status

git diff:
$diff"

spin() {
  local chars='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
  while true; do
    for ((i = 0; i < ${#chars}; i++)); do
      printf '\r%s Generating commit message...' "${chars:$i:1}"
      sleep 0.08
    done
  done
}

spin &
spin_pid=$!
trap 'kill $spin_pid 2>/dev/null; wait $spin_pid 2>/dev/null; printf "\r\033[K"' EXIT

msg=$(claude-wrapper -p "$prompt" --model haiku) || {
  kill $spin_pid 2>/dev/null || true
  wait $spin_pid 2>/dev/null || true
  trap - EXIT
  printf '\r\033[K'
  echo "Failed to generate commit message:"
  echo "$msg"
  exit 1
}

kill $spin_pid 2>/dev/null || true
wait $spin_pid 2>/dev/null || true
trap - EXIT
printf '\r\033[K'

if [ -z "$msg" ]; then
  echo "Failed to generate commit message."
  exit 1
fi

echo "Committing: $msg"
git commit -m "$msg"

if $push; then
  git push
fi
