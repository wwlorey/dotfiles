#!/bin/bash

# audio_to_wav.sh - Convert audio file to WAV format on macOS
# Requirements: Homebrew and ffmpeg (install with: brew install ffmpeg)
# Usage: ./audio_to_wav.sh input_file [output_file]
# Example: ./audio_to_wav.sh song.mp3 song.wav
# If no output_file specified, uses input filename with .wav extension

set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Check if ffmpeg is installed
if ! command -v ffmpeg &> /dev/null; then
    echo "Error: ffmpeg is required but not installed."
    echo "Install it with: brew install ffmpeg"
    exit 1
fi

# Check for input file argument
if [ $# -eq 0 ]; then
    echo "Usage: $0 <input_audio_file> [output_wav_file]"
    echo "Supported input formats: MP3, AAC, FLAC, OGG, M4A, OPUS, WMA, etc."
    exit 1
fi

INPUT_FILE="$1"
OUTPUT_FILE="${2:-${INPUT_FILE%.*}.wav}"

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: Input file '$INPUT_FILE' not found."
    exit 1
fi

# Check if output file already exists (optional safety)
if [ -f "$OUTPUT_FILE" ]; then
    echo "Warning: Output file '$OUTPUT_FILE' already exists. Overwriting..."
fi

echo "Converting: $INPUT_FILE -> $OUTPUT_FILE"
echo "Format: $(ffprobe -v quiet -show_entries stream=codec_name -of csv=p=0 "$INPUT_FILE") -> PCM WAV"

# Convert using ffmpeg with high-quality settings
# -i: input file
# -f wav: force WAV container
# -acodec pcm_s16le: 16-bit signed little-endian PCM (CD quality, broadly compatible)
# -ar 44100: 44.1kHz sample rate (standard)
# -ac 2: stereo (if mono, it will upmix)
# -y: overwrite output without asking
ffmpeg -i "$INPUT_FILE" -f wav -acodec pcm_s16le -ar 44100 -ac 2 -y "$OUTPUT_FILE" -v quiet

# Verify output file was created and has size
if [ -f "$OUTPUT_FILE" ] && [ -s "$OUTPUT_FILE" ]; then
    INPUT_SIZE=$(stat -f%z "$INPUT_FILE" 2>/dev/null || stat -c%s "$INPUT_FILE")
    OUTPUT_SIZE=$(stat -f%z "$OUTPUT_FILE" 2>/dev/null || stat -c%s "$OUTPUT_FILE")
    echo "✅ Conversion complete!"
    echo "  Input:  $INPUT_SIZE bytes"
    echo "  Output: $OUTPUT_SIZE bytes ($OUTPUT_FILE)"
else
    echo "❌ Conversion failed!"
    exit 1
fi
