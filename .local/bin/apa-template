#!/bin/bash


printHelp() {
  echo "Usage: apa-template [OPTION]... directory
Generates an APA7 template from \`truman-apa7-latex-template\` or \`student-apa7-latex-template\` at the given directory path.
NOTE: this script will create a new directory for you and does not allow the use of an existing directory.

Options
  -s, --student        use the APA 7 Student template version, otherwise the Truman template will be used

  The following options pertain only to the Truman template:
  -e, --exclude-bib   exclude the bibliography file when instantiating the template
  OR
  -b, --basic         instantiate a simplified template (no title page, abstract, bibliography, or bibliography file)
"
}

while getopts "ebsh-:" opt; do
  case $opt in
    e) excludeBib=1 ;;
    b) basic=1 ;;
    s) student=1 ;;
    h) printHelp && exit 0 ;;
    -)
      case "${OPTARG}" in
        student)      student=1 ;;
        exclude-bib)  excludeBib=1 ;;
        basic)        basic=1 ;;
        help)         printHelp && exit 0 ;;
        *) echo "Invalid option --${OPTARG}" >&2 ; printHelp && exit 1 ;;
      esac ;;
    \?) printHelp && exit 1 ;;
  esac
done

shift $((OPTIND-1))

if [ $basic ]; then
  excludeBib=1
fi

dir=$1

if ! [[ $dir ]]
then
  echo Please provide directory name.
  exit 1
fi

if [[ "$dir" == -* ]] || [[ "$dir" =~ ^-+$ ]]; then
  echo "Error: Directory name cannot start with '-' or be only dashes."
  exit 1
fi

if [ -d $dir ]; then
  echo "\"$dir\" directory already exists."
  exit 1
fi

file=$(basename $dir)

if [ $student ]; then
  repo="$HOME/Repos/student-apa7-latex-template/"
else
  repo="$HOME/Repos/truman-apa7-latex-template/"
fi

cp -r $repo $dir

if ! [[ $dir ]]
then
  echo Unable to create directory.
  exit 1
fi

cd "$dir"
trash .git *.bcf *.blg *.log *.pdf *.xml *.bbl *.aux README.md LICENSE 2>/dev/null || true

if [ $excludeBib ]; then
  trash *.bib 2>/dev/null || true
fi

if [ $student ]; then
  mv student-apa7-template.tex $file.tex
else
  # Load the appropriate tex file into truman-apa7-template.tex, removing the unneeded one.
  if [ $basic ]; then
    mv -f truman-apa7-template-SIMPLE.tex truman-apa7-template.tex
  else
    trash truman-apa7-template-SIMPLE.tex 2>/dev/null || true
  fi

  mv truman-apa7-template.tex $file.tex
fi

git init >> /dev/null
git add --all >> /dev/null
git commit -m "init" >> /dev/null

echo "APA7 template created in \"$dir\"."

